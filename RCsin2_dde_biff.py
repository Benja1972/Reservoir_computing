import numpy as np
import pylab as pl
from math import sin
from pydelay import dde23

# define the equations
eqns = { 
        'x' : '(1/tau) *(-x-y+beta*pow(sin(sc*(0.05967*x(t-0.0067*T)+\
                                            0.68260*x(t-0.0133*T)+\
                                            0.04247*x(t-0.0200*T)+\
                                            0.07151*x(t-0.0267*T)+\
                                            0.52213*x(t-0.0333*T)+\
                                            0.09682*x(t-0.0400*T)+\
                                            0.81890*x(t-0.0467*T)+\
                                            0.81830*x(t-0.0533*T)+\
                                            0.72310*x(t-0.0600*T)+\
                                            0.15000*x(t-0.0667*T)+\
                                            0.66021*x(t-0.0733*T)+\
                                            0.51907*x(t-0.0800*T)+\
                                            0.97387*x(t-0.0867*T)+\
                                            0.64959*x(t-0.0933*T)+\
                                            0.80107*x(t-0.1000*T)+\
                                            0.45422*x(t-0.1067*T)+\
                                            0.43279*x(t-0.1133*T)+\
                                            0.82607*x(t-0.1200*T)+\
                                            0.08355*x(t-0.1267*T)+\
                                            0.13329*x(t-0.1333*T)+\
                                            0.17355*x(t-0.1400*T)+\
                                            0.39130*x(t-0.1467*T)+\
                                            0.83214*x(t-0.1533*T)+\
                                            0.80410*x(t-0.1600*T)+\
                                            0.06053*x(t-0.1667*T)+\
                                            0.39963*x(t-0.1733*T)+\
                                            0.52736*x(t-0.1800*T)+\
                                            0.41718*x(t-0.1867*T)+\
                                            0.65746*x(t-0.1933*T)+\
                                            0.62855*x(t-0.2000*T)+\
                                            0.29225*x(t-0.2067*T)+\
                                            0.43205*x(t-0.2133*T)+\
                                            0.01550*x(t-0.2200*T)+\
                                            0.98497*x(t-0.2267*T)+\
                                            0.16732*x(t-0.2333*T)+\
                                            0.10631*x(t-0.2400*T)+\
                                            0.37275*x(t-0.2467*T)+\
                                            0.19830*x(t-0.2533*T)+\
                                            0.49014*x(t-0.2600*T)+\
                                            0.33981*x(t-0.2667*T)+\
                                            0.95251*x(t-0.2733*T)+\
                                            0.92118*x(t-0.2800*T)+\
                                            0.05273*x(t-0.2867*T)+\
                                            0.73854*x(t-0.2933*T)+\
                                            0.26937*x(t-0.3000*T)+\
                                            0.42322*x(t-0.3067*T)+\
                                            0.54838*x(t-0.3133*T)+\
                                            0.94360*x(t-0.3200*T)+\
                                            0.41813*x(t-0.3267*T)+\
                                            0.98396*x(t-0.3333*T)+\
                                            0.30173*x(t-0.3400*T)+\
                                            0.70174*x(t-0.3467*T)+\
                                            0.66695*x(t-0.3533*T)+\
                                            0.53962*x(t-0.3600*T)+\
                                            0.69875*x(t-0.3667*T)+\
                                            0.66714*x(t-0.3733*T)+\
                                            0.17830*x(t-0.3800*T)+\
                                            0.12813*x(t-0.3867*T)+\
                                            1.00000*x(t-0.3933*T)+\
                                            0.17128*x(t-0.4000*T)+\
                                            0.03263*x(t-0.4067*T)+\
                                            0.56172*x(t-0.4133*T)+\
                                            0.88268*x(t-0.4200*T)+\
                                            0.66979*x(t-0.4267*T)+\
                                            0.19061*x(t-0.4333*T)+\
                                            0.36926*x(t-0.4400*T)+\
                                            0.46115*x(t-0.4467*T)+\
                                            0.98254*x(t-0.4533*T)+\
                                            0.15655*x(t-0.4600*T)+\
                                            0.85631*x(t-0.4667*T)+\
                                            0.64536*x(t-0.4733*T)+\
                                            0.37662*x(t-0.4800*T)+\
                                            0.19110*x(t-0.4867*T)+\
                                            0.42865*x(t-0.4933*T)+\
                                            0.48247*x(t-0.5000*T)+\
                                            0.12072*x(t-0.5067*T)+\
                                            0.59005*x(t-0.5133*T)+\
                                            0.22640*x(t-0.5200*T)+\
                                            0.38497*x(t-0.5267*T)+\
                                            0.58352*x(t-0.5333*T)+\
                                            0.25204*x(t-0.5400*T)+\
                                            0.29071*x(t-0.5467*T)+\
                                            0.61766*x(t-0.5533*T)+\
                                            0.26553*x(t-0.5600*T)+\
                                            0.82514*x(t-0.5667*T)+\
                                            0.98357*x(t-0.5733*T)+\
                                            0.73092*x(t-0.5800*T)+\
                                            0.34419*x(t-0.5867*T)+\
                                            0.58461*x(t-0.5933*T)+\
                                            0.10787*x(t-0.6000*T)+\
                                            0.90714*x(t-0.6067*T)+\
                                            0.88046*x(t-0.6133*T)+\
                                            0.81851*x(t-0.6200*T)+\
                                            0.26097*x(t-0.6267*T)+\
                                            0.59490*x(t-0.6333*T)+\
                                            0.02253*x(t-0.6400*T)+\
                                            0.42565*x(t-0.6467*T)+\
                                            0.31301*x(t-0.6533*T)+\
                                            0.16163*x(t-0.6600*T)+\
                                            0.17893*x(t-0.6667*T)+\
                                            0.42327*x(t-0.6733*T)+\
                                            0.09432*x(t-0.6800*T)+\
                                            0.59907*x(t-0.6867*T)+\
                                            0.47136*x(t-0.6933*T)+\
                                            0.69659*x(t-0.7000*T)+\
                                            0.70053*x(t-0.7067*T)+\
                                            0.63912*x(t-0.7133*T)+\
                                            0.03363*x(t-0.7200*T)+\
                                            0.06887*x(t-0.7267*T)+\
                                            0.31989*x(t-0.7333*T)+\
                                            0.53135*x(t-0.7400*T)+\
                                            0.65505*x(t-0.7467*T)+\
                                            0.40799*x(t-0.7533*T)+\
                                            0.82074*x(t-0.7600*T)+\
                                            0.71902*x(t-0.7667*T)+\
                                            0.96954*x(t-0.7733*T)+\
                                            0.53182*x(t-0.7800*T)+\
                                            0.32544*x(t-0.7867*T)+\
                                            0.10573*x(t-0.7933*T)+\
                                            0.61152*x(t-0.8000*T)+\
                                            0.77952*x(t-0.8067*T)+\
                                            0.42384*x(t-0.8133*T)+\
                                            0.09091*x(t-0.8200*T)+\
                                            0.26672*x(t-0.8267*T)+\
                                            0.15380*x(t-0.8333*T)+\
                                            0.28126*x(t-0.8400*T)+\
                                            0.44049*x(t-0.8467*T)+\
                                            0.52763*x(t-0.8533*T)+\
                                            0.45785*x(t-0.8600*T)+\
                                            0.87618*x(t-0.8667*T)+\
                                            0.51853*x(t-0.8733*T)+\
                                            0.94449*x(t-0.8800*T)+\
                                            0.63830*x(t-0.8867*T)+\
                                            0.95858*x(t-0.8933*T)+\
                                            0.24093*x(t-0.9000*T)+\
                                            0.67674*x(t-0.9067*T)+\
                                            0.28933*x(t-0.9133*T)+\
                                            0.67243*x(t-0.9200*T)+\
                                            0.69578*x(t-0.9267*T)+\
                                            0.06806*x(t-0.9333*T)+\
                                            0.25502*x(t-0.9400*T)+\
                                            0.22425*x(t-0.9467*T)+\
                                            0.66845*x(t-0.9533*T)+\
                                            0.84517*x(t-0.9600*T)+\
                                            0.34478*x(t-0.9667*T)+\
                                            0.78124*x(t-0.9733*T)+\
                                            0.67595*x(t-0.9800*T)+\
                                            0.00672*x(t-0.9867*T)+\
                                            0.60272*x(t-0.9933*T)+\
                                            0.38713*x(t-1.0000*T))+Phi0),2)-\
                                            beta*pow(sin(Phi0),2))',
        'y' : '(1/theta)*x'
        }

bn=0.5;
bf=10.5;
bsteps=5;
hb=(bf-bn)/bsteps;

#define the parameters, times is in 'ms'
params = {
        'tau'   : 0.09,     # 0.008 ms < tau< 0.10 ms
        'beta'  : bn,
        'T'     : 10.5,       # 1.6 ms < T< 130 ms
        'Phi0'  : 0.25*np.pi,
        'theta' : 543.0,         # 0.8 ms < theta< 1*1000 ms
        'sc'    : 1/72.3924
        }
#print(params)

# set the history of to the constant function 0.5 (using a python lambda function)
histfunc = {
        'x': lambda t: 0.2*sin(0.2*t),
        'y': lambda t: 0.000003452
    }


#output diagramm
hbin=300;
Hist=np.zeros((bsteps+1,hbin));
Hdwn=-2.0;
Hup=2.0;


for k in range(1,bsteps+2):

    params['beta']=bn+(k-1)*hb
        
    # Initialise the solver
    dde = dde23(eqns=eqns, params=params)
    
    #set the simulation parameters
    # (solve from t=0 to t=tfinal and limit the maximum step size to dtmax)
    tfinal=18000
    tcut=7000
    dde.set_sim_params(tfinal=tfinal, dtmax=0.5, AbsTol=10**-6, RelTol=10**-3)
    
    # set the history
    dde.hist_from_funcs(histfunc, 100)
    
    
    # run the simulator
    dde.run()
   
    x = dde.sol['x']
    t = dde.sol['t']
    H, xedges = np.histogram(x[np.ceil(len(x)*0.6):], bins=hbin, range=(Hdwn,Hup))
    Hist[k-1,:]=H.astype(float)/max(H.astype(float))



#Show picture
T=params['T']
#beta=params['beta']
tau=params['tau']
theta=params['theta']

pl.imshow(np.transpose(Hist), extent=(bn,bf,Hdwn,Hup)) 
pl.axis('tight')
pl.title(r'$\theta=$ %1.2f, $\tau=$ %1.2f, T= %1.2f' 
            % (theta, tau, T ) )
pl.xlabel(r'$\beta$')
pl.ylabel('$x(t)$')
pl.show()
